name: Codebase Security Scan with Gemini 3

on:
  push:
    branches: 
      - '**'
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  security_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          # Fetch all history so git diff can compare against parent commits
          fetch-depth: 0 

      - name: Get Changed Files Diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Compare PR branch to its base branch (e.g. main)
            git diff origin/${{ github.base_ref }}...HEAD > changes.diff
          else
            # For pushes, compare current commit to the previous one
            # Handles the very first commit case with || true
            git diff HEAD~1 HEAD > changes.diff || touch changes.diff
          fi
          
          if [ -s changes.diff ]; then
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          else
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: Run Gemini 3 Flash Security Scan
        # Only run if there are actual code changes to scan
        if: env.HAS_CHANGES == 'true'
        uses: google-github-actions/run-gemini-cli@v0.1.18
        with:
          # Corrected 2026 input names
          gemini_model: 'gemini-3-flash'
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          prompt: |
            You are a Senior Security Engineer auditing a job portal for the Albanian Regions.
            Analyze the following git diff for security vulnerabilities:
            1. SQL Injection (especially in search/filter logic).
            2. Hardcoded secrets/API keys.
            3. Insecure data handling (GDPR/regional privacy).
            4. Broken Access Control.

            Provide findings in a concise Markdown table. If clean, say "No security issues detected."

            DIFF DATA:
            $(cat changes.diff)
        id: gemini_scan

      - name: Comment on PR
        # Only comment if it's a PR and Gemini found something to say
        if: github.event_name == 'pull_request' && steps.gemini_scan.outputs.text != ''
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ### ðŸ›¡ï¸ Gemini 3 Security Audit Findings
            ${{ steps.gemini_scan.outputs.text }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Job Summary
        # Always output the findings to the GitHub Actions "Summary" page
        if: steps.gemini_scan.outputs.text != ''
        run: |
          echo "## ðŸ›¡ï¸ Gemini 3 Security Report" >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.gemini_scan.outputs.text }}" >> $GITHUB_STEP_SUMMARY
