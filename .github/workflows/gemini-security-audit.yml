name: Codebase Security Scan with Gemini 3

on:
  push:
    branches: 
      - '**'
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  security_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Get Changed Files Diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff origin/${{ github.base_ref }}...HEAD > changes.diff
          else
            git diff HEAD~1 HEAD > changes.diff || touch changes.diff
          fi
          
          if [ -s changes.diff ]; then
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          else
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: Run Gemini 3 Flash Security Scan
        if: env.HAS_CHANGES == 'true'
        uses: google-github-actions/run-gemini-cli@v0.1.18
        with:
          gemini_model: 'gemini-3-flash'
          gemini_api_key: ${{ secrets.GEMINI_API_KEY }}
          # We pass a minimal JSON settings to enable non-interactive/YOLO mode
          settings: |
            {
              "yolo": true,
              "nonInteractive": true
            }
          # This is the "Positional Argument" fix:
          # We provide the instructions directly to the CLI command
          # while using the action's context.
        run: |
          PROMPT="Analyze this git diff for security vulnerabilities in a Markdown table. Focus on SQLi, hardcoded keys, and Albanian data privacy. DIFF: $(cat changes.diff)"
          gemini "$PROMPT" > gemini_report.md
        id: gemini_scan

      - name: Comment on PR
        if: github.event_name == 'pull_request'
        uses: thollander/actions-comment-pull-request@v2
        with:
          message: |
            ### ðŸ›¡ï¸ Gemini 3 Security Audit Findings
            $(cat gemini_report.md)
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Job Summary
        run: |
          echo "## ðŸ›¡ï¸ Gemini 3 Security Report" >> $GITHUB_STEP_SUMMARY
          cat gemini_report.md >> $GITHUB_STEP_SUMMARY
