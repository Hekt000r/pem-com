name: Gemini 3 Security Audit

on:
  push:
    branches: ['**']
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  pull-requests: write

jobs:
  security_scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 

      - name: Get Changed Files Diff
        id: diff
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            git diff origin/${{ github.base_ref }}...HEAD > changes.diff
          else
            git diff HEAD~1 HEAD > changes.diff || touch changes.diff
          fi
          
          # Check if diff is empty
          if [ -s changes.diff ]; then
            echo "HAS_CHANGES=true" >> $GITHUB_ENV
          else
            echo "HAS_CHANGES=false" >> $GITHUB_ENV
          fi

      - name: Setup Python
        if: env.HAS_CHANGES == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Google GenAI SDK (New Standard)
        if: env.HAS_CHANGES == 'true'
        # We install the NEW package, not the deprecated one
        run: pip install -U google-genai

      - name: Run Gemini Security Scan
        if: env.HAS_CHANGES == 'true'
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          python -c "
          import os
          from google import genai
          
          # 1. Initialize the new Client (2026 standard)
          client = genai.Client(api_key=os.environ['GEMINI_API_KEY'])
          
          # 2. Read the Diff
          with open('changes.diff', 'r') as f:
              diff_text = f.read()

          # 3. Construct the prompt
          prompt = f'''
          You are a Senior Security Engineer. Audit this git diff for vulnerabilities.
          Focus on: SQL Injection, Hardcoded Secrets, and Albanian Data Privacy compliance.
          Output a concise Markdown table. If no issues, say 'No security issues detected'.

          DIFF DATA:
          {diff_text}
          '''

          try:
              # 4. Call the new API method with the correct model ID
              response = client.models.generate_content(
                  model='gemini-3-flash-preview', 
                  contents=prompt
              )
              
              with open('gemini_report.md', 'w') as f:
                  f.write(response.text)
                  
          except Exception as e:
              print(f'Gemini API Error: {e}')
              exit(1)
          "

      - name: Post Comment on PR
        if: github.event_name == 'pull_request' && env.HAS_CHANGES == 'true'
        uses: thollander/actions-comment-pull-request@v2
        with:
          filePath: gemini_report.md
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Job Summary
        if: env.HAS_CHANGES == 'true'
        run: |
          echo "## ðŸ›¡ï¸ Gemini 3 Security Audit" >> $GITHUB_STEP_SUMMARY
          cat gemini_report.md >> $GITHUB_STEP_SUMMARY
